defmodule EventManager.Plugins.DiscordTest do
  use ExUnit.Case

  alias EventManager.Plugins
  alias EventManager.Plugins.Discord
  alias EventManager.Repository

  @data "000030adfa06a8490000000000d0986b171061737369676e65645f6163636f756e7400104cabbef9391b7d0962616c6c6f745f696400d201000004d3aa6f0e636c69656e745f76657273696f6e010f312e302e313320306338316464653610636f6e74726163745f76657273696f6e010e312e302e312033363665386466651264656665727265645f706572635f783130300432000000000000000b6465736372697074696f6e010b46524f4d204a53444444440a656e645f706572696f64043c0000000000000015687573645f73616c6172795f7065725f706861736502639400000000000002485553440000001768766f6963655f73616c6172795f7065725f7068617365028e510200000000000248564f494345001668797068615f73616c6172795f7065725f7068617365020859000000000000024859504841000016696e7374616e745f687573645f706572635f78313030043200000000000000126f726967696e616c5f6f626a6563745f69640400000000000000000e6f726967696e616c5f73636f70650000409e4a4ee63036056f776e657200104cabbef9391b7d07726f6c655f69640400000000000000001d73656564735f657363726f775f73616c6172795f7065725f7068617365028054c21a0000000004534545445300000c73746172745f706572696f64043a000000000000000f74696d655f73686172655f78313030043200000000000000057469746c650100137472785f616374696f6e5f636f6e747261637400000030adfa06a8490f7472785f616374696f6e5f6e616d6500003252ef50c5ae920474797065000000000000905d520375726c0100"

  describe "Discord Plugin Test" do
    test "Discord notification test " do
      parsed_data = EventManager.Eos.unpack_data(@data)

      discord_params =
        EventManager.Repository.Metadata.search_metadata("event", "publsh.hypha")
        |> List.first()
        |> Repository.parse_metadata(parsed_data)
        |> List.first()
        |> Discord.new()

      assert {:ok, _resp} = EventManager.Handler.handle_action(%{"act" => %{"data" => @data}})
    end
  end
end
